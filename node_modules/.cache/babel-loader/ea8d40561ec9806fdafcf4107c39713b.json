{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar processLock_1 = require(\"./processLock\");\n/**\n * @author: SuperTokens (https://github.com/supertokens)\n * This library was created as a part of a larger project, SuperTokens(https://supertokens.io) - the best session management solution.\n * You can also check out our other projects on https://github.com/supertokens\n *\n * To contribute to this package visit https://github.com/supertokens/browser-tabs-lock\n * If you face any problems you can file an issue on https://github.com/supertokens/browser-tabs-lock/issues\n *\n * If you have any questions or if you just want to say hi visit https://supertokens.io/discord\n */\n\n/**\n * @constant\n * @type {string}\n * @default\n * @description All the locks taken by this package will have this as prefix\n*/\n\n\nvar LOCK_STORAGE_KEY = 'browser-tabs-lock-key';\n/**\n * @function delay\n * @param {number} milliseconds - How long the delay should be in terms of milliseconds\n * @returns {Promise<void>}\n */\n\nfunction delay(milliseconds) {\n  return new Promise(function (resolve) {\n    return setTimeout(resolve, milliseconds);\n  });\n}\n/**\n * @function generateRandomString\n * @params {number} length - How long the random string should be\n * @returns {string}\n * @description returns random string whose length is equal to the length passed as parameter\n */\n\n\nfunction generateRandomString(length) {\n  var CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz';\n  var randomstring = '';\n\n  for (var i = 0; i < length; i++) {\n    var INDEX = Math.floor(Math.random() * CHARS.length);\n    randomstring += CHARS[INDEX];\n  }\n\n  return randomstring;\n}\n/**\n * @function getLockId\n * @returns {string}\n * @description Generates an id which will be unique for the browser tab\n */\n\n\nfunction getLockId() {\n  return Date.now().toString() + generateRandomString(15);\n}\n\nvar SuperTokensLock =\n/** @class */\nfunction () {\n  function SuperTokensLock() {\n    this.acquiredIatSet = new Set();\n    this.id = getLockId();\n    this.acquireLock = this.acquireLock.bind(this);\n    this.releaseLock = this.releaseLock.bind(this);\n    this.releaseLock__private__ = this.releaseLock__private__.bind(this);\n    this.waitForSomethingToChange = this.waitForSomethingToChange.bind(this);\n    this.refreshLockWhileAcquired = this.refreshLockWhileAcquired.bind(this);\n\n    if (SuperTokensLock.waiters === undefined) {\n      SuperTokensLock.waiters = [];\n    }\n  }\n  /**\n   * @async\n   * @memberOf Lock\n   * @function acquireLock\n   * @param {string} lockKey - Key for which the lock is being acquired\n   * @param {number} [timeout=5000] - Maximum time for which the function will wait to acquire the lock\n   * @returns {Promise<boolean>}\n   * @description Will return true if lock is being acquired, else false.\n   *              Also the lock can be acquired for maximum 10 secs\n   */\n\n\n  SuperTokensLock.prototype.acquireLock = function (lockKey, timeout) {\n    if (timeout === void 0) {\n      timeout = 5000;\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      var iat, MAX_TIME, STORAGE_KEY, STORAGE, lockObj, TIMEOUT_KEY, lockObjPostDelay;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            iat = Date.now() + generateRandomString(4);\n            MAX_TIME = Date.now() + timeout;\n            STORAGE_KEY = LOCK_STORAGE_KEY + \"-\" + lockKey;\n            STORAGE = window.localStorage;\n            _a.label = 1;\n\n          case 1:\n            if (!(Date.now() < MAX_TIME)) return [3\n            /*break*/\n            , 8];\n            return [4\n            /*yield*/\n            , delay(30)];\n\n          case 2:\n            _a.sent();\n\n            lockObj = STORAGE.getItem(STORAGE_KEY);\n            if (!(lockObj === null)) return [3\n            /*break*/\n            , 5];\n            TIMEOUT_KEY = this.id + \"-\" + lockKey + \"-\" + iat; // there is a problem if setItem happens at the exact same time for 2 different processes.. so we add some random delay here.\n\n            return [4\n            /*yield*/\n            , delay(Math.floor(Math.random() * 25))];\n\n          case 3:\n            // there is a problem if setItem happens at the exact same time for 2 different processes.. so we add some random delay here.\n            _a.sent();\n\n            STORAGE.setItem(STORAGE_KEY, JSON.stringify({\n              id: this.id,\n              iat: iat,\n              timeoutKey: TIMEOUT_KEY,\n              timeAcquired: Date.now(),\n              timeRefreshed: Date.now()\n            }));\n            return [4\n            /*yield*/\n            , delay(30)];\n\n          case 4:\n            _a.sent(); // this is to prevent race conditions. This time must be more than the time it takes for storage.setItem\n\n\n            lockObjPostDelay = STORAGE.getItem(STORAGE_KEY);\n\n            if (lockObjPostDelay !== null) {\n              lockObjPostDelay = JSON.parse(lockObjPostDelay);\n\n              if (lockObjPostDelay.id === this.id && lockObjPostDelay.iat === iat) {\n                this.acquiredIatSet.add(iat);\n                this.refreshLockWhileAcquired(STORAGE_KEY, iat);\n                return [2\n                /*return*/\n                , true];\n              }\n            }\n\n            return [3\n            /*break*/\n            , 7];\n\n          case 5:\n            SuperTokensLock.lockCorrector();\n            return [4\n            /*yield*/\n            , this.waitForSomethingToChange(MAX_TIME)];\n\n          case 6:\n            _a.sent();\n\n            _a.label = 7;\n\n          case 7:\n            iat = Date.now() + generateRandomString(4);\n            return [3\n            /*break*/\n            , 1];\n\n          case 8:\n            return [2\n            /*return*/\n            , false];\n        }\n      });\n    });\n  };\n\n  SuperTokensLock.prototype.refreshLockWhileAcquired = function (storageKey, iat) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        setTimeout(function () {\n          return __awaiter(_this, void 0, void 0, function () {\n            var STORAGE, lockObj;\n            return __generator(this, function (_a) {\n              switch (_a.label) {\n                case 0:\n                  return [4\n                  /*yield*/\n                  , processLock_1.default().lock(iat)];\n\n                case 1:\n                  _a.sent();\n\n                  if (!this.acquiredIatSet.has(iat)) {\n                    processLock_1.default().unlock(iat);\n                    return [2\n                    /*return*/\n                    ];\n                  }\n\n                  STORAGE = window.localStorage;\n                  lockObj = STORAGE.getItem(storageKey);\n\n                  if (lockObj !== null) {\n                    lockObj = JSON.parse(lockObj);\n                    lockObj.timeRefreshed = Date.now();\n                    STORAGE.setItem(storageKey, JSON.stringify(lockObj));\n                    processLock_1.default().unlock(iat);\n                  } else {\n                    processLock_1.default().unlock(iat);\n                    return [2\n                    /*return*/\n                    ];\n                  }\n\n                  this.refreshLockWhileAcquired(storageKey, iat);\n                  return [2\n                  /*return*/\n                  ];\n              }\n            });\n          });\n        }, 1000);\n        return [2\n        /*return*/\n        ];\n      });\n    });\n  };\n\n  SuperTokensLock.prototype.waitForSomethingToChange = function (MAX_TIME) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , new Promise(function (resolve) {\n              var resolvedCalled = false;\n              var startedAt = Date.now();\n              var MIN_TIME_TO_WAIT = 50; // ms\n\n              var removedListeners = false;\n\n              function stopWaiting() {\n                if (!removedListeners) {\n                  window.removeEventListener('storage', stopWaiting);\n                  SuperTokensLock.removeFromWaiting(stopWaiting);\n                  clearTimeout(timeOutId);\n                  removedListeners = true;\n                }\n\n                if (!resolvedCalled) {\n                  resolvedCalled = true;\n                  var timeToWait = MIN_TIME_TO_WAIT - (Date.now() - startedAt);\n\n                  if (timeToWait > 0) {\n                    setTimeout(resolve, timeToWait);\n                  } else {\n                    resolve();\n                  }\n                }\n              }\n\n              window.addEventListener('storage', stopWaiting);\n              SuperTokensLock.addToWaiting(stopWaiting);\n              var timeOutId = setTimeout(stopWaiting, Math.max(0, MAX_TIME - Date.now()));\n            })];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  SuperTokensLock.addToWaiting = function (func) {\n    this.removeFromWaiting(func);\n\n    if (SuperTokensLock.waiters === undefined) {\n      return;\n    }\n\n    SuperTokensLock.waiters.push(func);\n  };\n\n  SuperTokensLock.removeFromWaiting = function (func) {\n    if (SuperTokensLock.waiters === undefined) {\n      return;\n    }\n\n    SuperTokensLock.waiters = SuperTokensLock.waiters.filter(function (i) {\n      return i !== func;\n    });\n  };\n\n  SuperTokensLock.notifyWaiters = function () {\n    if (SuperTokensLock.waiters === undefined) {\n      return;\n    }\n\n    var waiters = SuperTokensLock.waiters.slice(); // so that if Lock.waiters is changed it's ok.\n\n    waiters.forEach(function (i) {\n      return i();\n    });\n  };\n  /**\n   * @function releaseLock\n   * @memberOf Lock\n   * @param {string} lockKey - Key for which lock is being released\n   * @returns {void}\n   * @description Release a lock.\n   */\n\n\n  SuperTokensLock.prototype.releaseLock = function (lockKey) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.releaseLock__private__(lockKey)];\n\n          case 1:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n  /**\n   * @function releaseLock\n   * @memberOf Lock\n   * @param {string} lockKey - Key for which lock is being released\n   * @returns {void}\n   * @description Release a lock.\n   */\n\n\n  SuperTokensLock.prototype.releaseLock__private__ = function (lockKey) {\n    return __awaiter(this, void 0, void 0, function () {\n      var STORAGE, STORAGE_KEY, lockObj;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            STORAGE = window.localStorage;\n            STORAGE_KEY = LOCK_STORAGE_KEY + \"-\" + lockKey;\n            lockObj = STORAGE.getItem(STORAGE_KEY);\n\n            if (lockObj === null) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            lockObj = JSON.parse(lockObj);\n            if (!(lockObj.id === this.id)) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , processLock_1.default().lock(lockObj.iat)];\n\n          case 1:\n            _a.sent();\n\n            this.acquiredIatSet.delete(lockObj.iat);\n            STORAGE.removeItem(STORAGE_KEY);\n            processLock_1.default().unlock(lockObj.iat);\n            SuperTokensLock.notifyWaiters();\n            _a.label = 2;\n\n          case 2:\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n  /**\n   * @function lockCorrector\n   * @returns {void}\n   * @description If a lock is acquired by a tab and the tab is closed before the lock is\n   *              released, this function will release those locks\n   */\n\n\n  SuperTokensLock.lockCorrector = function () {\n    var MIN_ALLOWED_TIME = Date.now() - 5000;\n    var STORAGE = window.localStorage;\n    var KEYS = Object.keys(STORAGE);\n    var notifyWaiters = false;\n\n    for (var i = 0; i < KEYS.length; i++) {\n      var LOCK_KEY = KEYS[i];\n\n      if (LOCK_KEY.includes(LOCK_STORAGE_KEY)) {\n        var lockObj = STORAGE.getItem(LOCK_KEY);\n\n        if (lockObj !== null) {\n          lockObj = JSON.parse(lockObj);\n\n          if (lockObj.timeRefreshed === undefined && lockObj.timeAcquired < MIN_ALLOWED_TIME || lockObj.timeRefreshed !== undefined && lockObj.timeRefreshed < MIN_ALLOWED_TIME) {\n            STORAGE.removeItem(LOCK_KEY);\n            notifyWaiters = true;\n          }\n        }\n      }\n    }\n\n    if (notifyWaiters) {\n      SuperTokensLock.notifyWaiters();\n    }\n  };\n\n  SuperTokensLock.waiters = undefined;\n  return SuperTokensLock;\n}();\n\nexports.default = SuperTokensLock;","map":{"version":3,"sources":["/home/dom/FlyM/node_modules/browser-tabs-lock/index.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__generator","body","_","label","sent","t","trys","ops","f","y","g","verb","Symbol","iterator","n","v","op","TypeError","call","pop","length","push","Object","defineProperty","exports","processLock_1","require","LOCK_STORAGE_KEY","delay","milliseconds","setTimeout","generateRandomString","CHARS","randomstring","i","INDEX","Math","floor","random","getLockId","Date","now","toString","SuperTokensLock","acquiredIatSet","Set","id","acquireLock","bind","releaseLock","releaseLock__private__","waitForSomethingToChange","refreshLockWhileAcquired","waiters","undefined","prototype","lockKey","timeout","iat","MAX_TIME","STORAGE_KEY","STORAGE","lockObj","TIMEOUT_KEY","lockObjPostDelay","_a","window","localStorage","getItem","setItem","JSON","stringify","timeoutKey","timeAcquired","timeRefreshed","parse","add","lockCorrector","storageKey","_this","default","lock","has","unlock","resolvedCalled","startedAt","MIN_TIME_TO_WAIT","removedListeners","stopWaiting","removeEventListener","removeFromWaiting","clearTimeout","timeOutId","timeToWait","addEventListener","addToWaiting","max","func","filter","notifyWaiters","slice","forEach","delete","removeItem","MIN_ALLOWED_TIME","KEYS","keys","LOCK_KEY","includes"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar processLock_1 = require(\"./processLock\");\n/**\n * @author: SuperTokens (https://github.com/supertokens)\n * This library was created as a part of a larger project, SuperTokens(https://supertokens.io) - the best session management solution.\n * You can also check out our other projects on https://github.com/supertokens\n *\n * To contribute to this package visit https://github.com/supertokens/browser-tabs-lock\n * If you face any problems you can file an issue on https://github.com/supertokens/browser-tabs-lock/issues\n *\n * If you have any questions or if you just want to say hi visit https://supertokens.io/discord\n */\n/**\n * @constant\n * @type {string}\n * @default\n * @description All the locks taken by this package will have this as prefix\n*/\nvar LOCK_STORAGE_KEY = 'browser-tabs-lock-key';\n/**\n * @function delay\n * @param {number} milliseconds - How long the delay should be in terms of milliseconds\n * @returns {Promise<void>}\n */\nfunction delay(milliseconds) {\n    return new Promise(function (resolve) { return setTimeout(resolve, milliseconds); });\n}\n/**\n * @function generateRandomString\n * @params {number} length - How long the random string should be\n * @returns {string}\n * @description returns random string whose length is equal to the length passed as parameter\n */\nfunction generateRandomString(length) {\n    var CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz';\n    var randomstring = '';\n    for (var i = 0; i < length; i++) {\n        var INDEX = Math.floor(Math.random() * CHARS.length);\n        randomstring += CHARS[INDEX];\n    }\n    return randomstring;\n}\n/**\n * @function getLockId\n * @returns {string}\n * @description Generates an id which will be unique for the browser tab\n */\nfunction getLockId() {\n    return Date.now().toString() + generateRandomString(15);\n}\nvar SuperTokensLock = /** @class */ (function () {\n    function SuperTokensLock() {\n        this.acquiredIatSet = new Set();\n        this.id = getLockId();\n        this.acquireLock = this.acquireLock.bind(this);\n        this.releaseLock = this.releaseLock.bind(this);\n        this.releaseLock__private__ = this.releaseLock__private__.bind(this);\n        this.waitForSomethingToChange = this.waitForSomethingToChange.bind(this);\n        this.refreshLockWhileAcquired = this.refreshLockWhileAcquired.bind(this);\n        if (SuperTokensLock.waiters === undefined) {\n            SuperTokensLock.waiters = [];\n        }\n    }\n    /**\n     * @async\n     * @memberOf Lock\n     * @function acquireLock\n     * @param {string} lockKey - Key for which the lock is being acquired\n     * @param {number} [timeout=5000] - Maximum time for which the function will wait to acquire the lock\n     * @returns {Promise<boolean>}\n     * @description Will return true if lock is being acquired, else false.\n     *              Also the lock can be acquired for maximum 10 secs\n     */\n    SuperTokensLock.prototype.acquireLock = function (lockKey, timeout) {\n        if (timeout === void 0) { timeout = 5000; }\n        return __awaiter(this, void 0, void 0, function () {\n            var iat, MAX_TIME, STORAGE_KEY, STORAGE, lockObj, TIMEOUT_KEY, lockObjPostDelay;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        iat = Date.now() + generateRandomString(4);\n                        MAX_TIME = Date.now() + timeout;\n                        STORAGE_KEY = LOCK_STORAGE_KEY + \"-\" + lockKey;\n                        STORAGE = window.localStorage;\n                        _a.label = 1;\n                    case 1:\n                        if (!(Date.now() < MAX_TIME)) return [3 /*break*/, 8];\n                        return [4 /*yield*/, delay(30)];\n                    case 2:\n                        _a.sent();\n                        lockObj = STORAGE.getItem(STORAGE_KEY);\n                        if (!(lockObj === null)) return [3 /*break*/, 5];\n                        TIMEOUT_KEY = this.id + \"-\" + lockKey + \"-\" + iat;\n                        // there is a problem if setItem happens at the exact same time for 2 different processes.. so we add some random delay here.\n                        return [4 /*yield*/, delay(Math.floor(Math.random() * 25))];\n                    case 3:\n                        // there is a problem if setItem happens at the exact same time for 2 different processes.. so we add some random delay here.\n                        _a.sent();\n                        STORAGE.setItem(STORAGE_KEY, JSON.stringify({\n                            id: this.id,\n                            iat: iat,\n                            timeoutKey: TIMEOUT_KEY,\n                            timeAcquired: Date.now(),\n                            timeRefreshed: Date.now()\n                        }));\n                        return [4 /*yield*/, delay(30)];\n                    case 4:\n                        _a.sent(); // this is to prevent race conditions. This time must be more than the time it takes for storage.setItem\n                        lockObjPostDelay = STORAGE.getItem(STORAGE_KEY);\n                        if (lockObjPostDelay !== null) {\n                            lockObjPostDelay = JSON.parse(lockObjPostDelay);\n                            if (lockObjPostDelay.id === this.id && lockObjPostDelay.iat === iat) {\n                                this.acquiredIatSet.add(iat);\n                                this.refreshLockWhileAcquired(STORAGE_KEY, iat);\n                                return [2 /*return*/, true];\n                            }\n                        }\n                        return [3 /*break*/, 7];\n                    case 5:\n                        SuperTokensLock.lockCorrector();\n                        return [4 /*yield*/, this.waitForSomethingToChange(MAX_TIME)];\n                    case 6:\n                        _a.sent();\n                        _a.label = 7;\n                    case 7:\n                        iat = Date.now() + generateRandomString(4);\n                        return [3 /*break*/, 1];\n                    case 8: return [2 /*return*/, false];\n                }\n            });\n        });\n    };\n    SuperTokensLock.prototype.refreshLockWhileAcquired = function (storageKey, iat) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _this = this;\n            return __generator(this, function (_a) {\n                setTimeout(function () { return __awaiter(_this, void 0, void 0, function () {\n                    var STORAGE, lockObj;\n                    return __generator(this, function (_a) {\n                        switch (_a.label) {\n                            case 0: return [4 /*yield*/, processLock_1.default().lock(iat)];\n                            case 1:\n                                _a.sent();\n                                if (!this.acquiredIatSet.has(iat)) {\n                                    processLock_1.default().unlock(iat);\n                                    return [2 /*return*/];\n                                }\n                                STORAGE = window.localStorage;\n                                lockObj = STORAGE.getItem(storageKey);\n                                if (lockObj !== null) {\n                                    lockObj = JSON.parse(lockObj);\n                                    lockObj.timeRefreshed = Date.now();\n                                    STORAGE.setItem(storageKey, JSON.stringify(lockObj));\n                                    processLock_1.default().unlock(iat);\n                                }\n                                else {\n                                    processLock_1.default().unlock(iat);\n                                    return [2 /*return*/];\n                                }\n                                this.refreshLockWhileAcquired(storageKey, iat);\n                                return [2 /*return*/];\n                        }\n                    });\n                }); }, 1000);\n                return [2 /*return*/];\n            });\n        });\n    };\n    SuperTokensLock.prototype.waitForSomethingToChange = function (MAX_TIME) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, new Promise(function (resolve) {\n                            var resolvedCalled = false;\n                            var startedAt = Date.now();\n                            var MIN_TIME_TO_WAIT = 50; // ms\n                            var removedListeners = false;\n                            function stopWaiting() {\n                                if (!removedListeners) {\n                                    window.removeEventListener('storage', stopWaiting);\n                                    SuperTokensLock.removeFromWaiting(stopWaiting);\n                                    clearTimeout(timeOutId);\n                                    removedListeners = true;\n                                }\n                                if (!resolvedCalled) {\n                                    resolvedCalled = true;\n                                    var timeToWait = MIN_TIME_TO_WAIT - (Date.now() - startedAt);\n                                    if (timeToWait > 0) {\n                                        setTimeout(resolve, timeToWait);\n                                    }\n                                    else {\n                                        resolve();\n                                    }\n                                }\n                            }\n                            window.addEventListener('storage', stopWaiting);\n                            SuperTokensLock.addToWaiting(stopWaiting);\n                            var timeOutId = setTimeout(stopWaiting, Math.max(0, MAX_TIME - Date.now()));\n                        })];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    SuperTokensLock.addToWaiting = function (func) {\n        this.removeFromWaiting(func);\n        if (SuperTokensLock.waiters === undefined) {\n            return;\n        }\n        SuperTokensLock.waiters.push(func);\n    };\n    SuperTokensLock.removeFromWaiting = function (func) {\n        if (SuperTokensLock.waiters === undefined) {\n            return;\n        }\n        SuperTokensLock.waiters = SuperTokensLock.waiters.filter(function (i) { return i !== func; });\n    };\n    SuperTokensLock.notifyWaiters = function () {\n        if (SuperTokensLock.waiters === undefined) {\n            return;\n        }\n        var waiters = SuperTokensLock.waiters.slice(); // so that if Lock.waiters is changed it's ok.\n        waiters.forEach(function (i) { return i(); });\n    };\n    /**\n     * @function releaseLock\n     * @memberOf Lock\n     * @param {string} lockKey - Key for which lock is being released\n     * @returns {void}\n     * @description Release a lock.\n     */\n    SuperTokensLock.prototype.releaseLock = function (lockKey) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.releaseLock__private__(lockKey)];\n                    case 1: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    /**\n     * @function releaseLock\n     * @memberOf Lock\n     * @param {string} lockKey - Key for which lock is being released\n     * @returns {void}\n     * @description Release a lock.\n     */\n    SuperTokensLock.prototype.releaseLock__private__ = function (lockKey) {\n        return __awaiter(this, void 0, void 0, function () {\n            var STORAGE, STORAGE_KEY, lockObj;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        STORAGE = window.localStorage;\n                        STORAGE_KEY = LOCK_STORAGE_KEY + \"-\" + lockKey;\n                        lockObj = STORAGE.getItem(STORAGE_KEY);\n                        if (lockObj === null) {\n                            return [2 /*return*/];\n                        }\n                        lockObj = JSON.parse(lockObj);\n                        if (!(lockObj.id === this.id)) return [3 /*break*/, 2];\n                        return [4 /*yield*/, processLock_1.default().lock(lockObj.iat)];\n                    case 1:\n                        _a.sent();\n                        this.acquiredIatSet.delete(lockObj.iat);\n                        STORAGE.removeItem(STORAGE_KEY);\n                        processLock_1.default().unlock(lockObj.iat);\n                        SuperTokensLock.notifyWaiters();\n                        _a.label = 2;\n                    case 2: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    /**\n     * @function lockCorrector\n     * @returns {void}\n     * @description If a lock is acquired by a tab and the tab is closed before the lock is\n     *              released, this function will release those locks\n     */\n    SuperTokensLock.lockCorrector = function () {\n        var MIN_ALLOWED_TIME = Date.now() - 5000;\n        var STORAGE = window.localStorage;\n        var KEYS = Object.keys(STORAGE);\n        var notifyWaiters = false;\n        for (var i = 0; i < KEYS.length; i++) {\n            var LOCK_KEY = KEYS[i];\n            if (LOCK_KEY.includes(LOCK_STORAGE_KEY)) {\n                var lockObj = STORAGE.getItem(LOCK_KEY);\n                if (lockObj !== null) {\n                    lockObj = JSON.parse(lockObj);\n                    if ((lockObj.timeRefreshed === undefined && lockObj.timeAcquired < MIN_ALLOWED_TIME) ||\n                        (lockObj.timeRefreshed !== undefined && lockObj.timeRefreshed < MIN_ALLOWED_TIME)) {\n                        STORAGE.removeItem(LOCK_KEY);\n                        notifyWaiters = true;\n                    }\n                }\n            }\n        }\n        if (notifyWaiters) {\n            SuperTokensLock.notifyWaiters();\n        }\n    };\n    SuperTokensLock.waiters = undefined;\n    return SuperTokensLock;\n}());\nexports.default = SuperTokensLock;\n"]},"metadata":{},"sourceType":"script"}