{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    throw: verb(1),\n    return: verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar fetch_1 = require(\"./fetch\");\n\nvar axios_1 = require(\"./axios\");\n\nvar version_1 = require(\"./version\");\n\nvar logger_1 = require(\"./logger\");\n\nvar error_1 = require(\"./error\");\n\nvar xmlhttprequest_1 = require(\"./xmlhttprequest\");\n\nfunction RecipeImplementation(recipeImplInput) {\n  return {\n    addXMLHttpRequestInterceptor: function (_) {\n      (0, logger_1.logDebugMessage)(\"addXMLHttpRequestInterceptorAndReturnModified: called\");\n      (0, xmlhttprequest_1.addInterceptorsToXMLHttpRequest)();\n    },\n    addFetchInterceptorsAndReturnModifiedFetch: function (input) {\n      (0, logger_1.logDebugMessage)(\"addFetchInterceptorsAndReturnModifiedFetch: called\");\n      return function (url, config) {\n        return __awaiter(this, void 0, void 0, function () {\n          return __generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                return [4\n                /*yield*/\n                , fetch_1.default.doRequest(function (config) {\n                  return input.originalFetch(typeof url === \"string\" ? url : url.clone(), __assign({}, config));\n                }, config, url)];\n\n              case 1:\n                return [2\n                /*return*/\n                , _a.sent()];\n            }\n          });\n        });\n      };\n    },\n    addAxiosInterceptors: function (input) {\n      (0, logger_1.logDebugMessage)(\"addAxiosInterceptors: called\");\n\n      if (XMLHttpRequest.__interceptedBySuperTokens) {\n        console.warn(\"Not adding axios interceptor since XMLHttpRequest is already added. This is just a warning.\");\n        console.warn(\"Our axios and XMLHttpRequest interceptors cannot be used at the same time.\");\n        console.warn(\"Since XMLHttpRequest is added automatically and supports axios by default, you can just remove addAxiosInterceptors from your code.\");\n        console.warn(\"If you want to continue using our axios interceptor, you can override addXMLHttpRequestInterceptor with an empty function.\");\n        (0, logger_1.logDebugMessage)(\"addAxiosInterceptors: not adding, because XHR interceptors are already in place\");\n        return;\n      } // we first check if this axiosInstance already has our interceptors.\n\n\n      var requestInterceptors = input.axiosInstance.interceptors.request;\n\n      for (var i = 0; i < requestInterceptors.handlers.length; i++) {\n        if (requestInterceptors.handlers[i].fulfilled === axios_1.interceptorFunctionRequestFulfilled) {\n          (0, logger_1.logDebugMessage)(\"addAxiosInterceptors: not adding because already added on this instance\");\n          return;\n        }\n      } // Add a request interceptor\n\n\n      input.axiosInstance.interceptors.request.use(axios_1.interceptorFunctionRequestFulfilled, function (error) {\n        return __awaiter(this, void 0, void 0, function () {\n          return __generator(this, function (_a) {\n            throw error;\n          });\n        });\n      }); // Add a response interceptor\n\n      input.axiosInstance.interceptors.response.use((0, axios_1.responseInterceptor)(input.axiosInstance), (0, axios_1.responseErrorInterceptor)(input.axiosInstance));\n    },\n    getUserId: function (_) {\n      return __awaiter(this, void 0, void 0, function () {\n        var tokenInfo;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              (0, logger_1.logDebugMessage)(\"getUserId: called\");\n              return [4\n              /*yield*/\n              , fetch_1.FrontToken.getTokenInfo()];\n\n            case 1:\n              tokenInfo = _a.sent();\n\n              if (tokenInfo === undefined) {\n                throw new Error(\"No session exists\");\n              }\n\n              (0, logger_1.logDebugMessage)(\"getUserId: returning: \" + tokenInfo.uid);\n              return [2\n              /*return*/\n              , tokenInfo.uid];\n          }\n        });\n      });\n    },\n    getAccessTokenPayloadSecurely: function (input) {\n      return __awaiter(this, void 0, void 0, function () {\n        var tokenInfo, retry;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              (0, logger_1.logDebugMessage)(\"getAccessTokenPayloadSecurely: called\");\n              return [4\n              /*yield*/\n              , fetch_1.FrontToken.getTokenInfo()];\n\n            case 1:\n              tokenInfo = _a.sent();\n\n              if (tokenInfo === undefined) {\n                throw new Error(\"No session exists\");\n              }\n\n              if (!(tokenInfo.ate < Date.now())) return [3\n              /*break*/\n              , 5];\n              (0, logger_1.logDebugMessage)(\"getAccessTokenPayloadSecurely: access token expired. Refreshing session\");\n              return [4\n              /*yield*/\n              , fetch_1.default.attemptRefreshingSession()];\n\n            case 2:\n              retry = _a.sent();\n              if (!retry) return [3\n              /*break*/\n              , 4];\n              return [4\n              /*yield*/\n              , this.getAccessTokenPayloadSecurely({\n                userContext: input.userContext\n              })];\n\n            case 3:\n              return [2\n              /*return*/\n              , _a.sent()];\n\n            case 4:\n              throw new Error(\"Could not refresh session\");\n\n            case 5:\n              (0, logger_1.logDebugMessage)(\"getAccessTokenPayloadSecurely: returning: \" + JSON.stringify(tokenInfo.up));\n              return [2\n              /*return*/\n              , tokenInfo.up];\n          }\n        });\n      });\n    },\n    doesSessionExist: function (_) {\n      return __awaiter(this, void 0, void 0, function () {\n        var tokenInfo, preRequestLSS, refresh;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              (0, logger_1.logDebugMessage)(\"doesSessionExist: called\");\n              return [4\n              /*yield*/\n              , fetch_1.FrontToken.getTokenInfo()];\n\n            case 1:\n              tokenInfo = _a.sent(); // The above includes getLocalSessionState(true), which would call refresh if the FE cookies were cleared for some reason\n\n              if (tokenInfo === undefined) {\n                (0, logger_1.logDebugMessage)(\"doesSessionExist: access token does not exist locally\");\n                return [2\n                /*return*/\n                , false];\n              }\n\n              if (!(tokenInfo.ate < Date.now())) return [3\n              /*break*/\n              , 4];\n              (0, logger_1.logDebugMessage)(\"doesSessionExist: access token expired. Refreshing session\");\n              return [4\n              /*yield*/\n              , (0, fetch_1.getLocalSessionState)(false)];\n\n            case 2:\n              preRequestLSS = _a.sent();\n              return [4\n              /*yield*/\n              , (0, fetch_1.onUnauthorisedResponse)(preRequestLSS)];\n\n            case 3:\n              refresh = _a.sent();\n              return [2\n              /*return*/\n              , refresh.result === \"RETRY\"];\n\n            case 4:\n              return [2\n              /*return*/\n              , true];\n          }\n        });\n      });\n    },\n    signOut: function (input) {\n      return __awaiter(this, void 0, void 0, function () {\n        var preAPIResult, resp, responseJson, message;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              (0, logger_1.logDebugMessage)(\"signOut: called\");\n              return [4\n              /*yield*/\n              , this.doesSessionExist(input)];\n\n            case 1:\n              if (!_a.sent()) {\n                (0, logger_1.logDebugMessage)(\"signOut: exiting early because session does not exist\");\n                (0, logger_1.logDebugMessage)(\"signOut: firing SIGN_OUT event\");\n                recipeImplInput.onHandleEvent({\n                  action: \"SIGN_OUT\",\n                  userContext: input.userContext\n                });\n                return [2\n                /*return*/\n                ];\n              }\n\n              (0, logger_1.logDebugMessage)(\"signOut: Calling refresh pre API hook\");\n              return [4\n              /*yield*/\n              , recipeImplInput.preAPIHook({\n                action: \"SIGN_OUT\",\n                requestInit: {\n                  method: \"post\",\n                  headers: {\n                    \"fdi-version\": version_1.supported_fdi.join(\",\"),\n                    rid: fetch_1.default.rid\n                  }\n                },\n                url: fetch_1.default.signOutUrl,\n                userContext: input.userContext\n              })];\n\n            case 2:\n              preAPIResult = _a.sent();\n              (0, logger_1.logDebugMessage)(\"signOut: Calling API\");\n              return [4\n              /*yield*/\n              , fetch(preAPIResult.url, preAPIResult.requestInit)];\n\n            case 3:\n              resp = _a.sent();\n              (0, logger_1.logDebugMessage)(\"signOut: API ended\");\n              (0, logger_1.logDebugMessage)(\"signOut: API responded with status code: \" + resp.status);\n\n              if (resp.status === recipeImplInput.sessionExpiredStatusCode) {\n                // refresh must have already sent session expiry event\n                return [2\n                /*return*/\n                ];\n              }\n\n              if (resp.status >= 300) {\n                throw resp;\n              }\n\n              return [4\n              /*yield*/\n              , recipeImplInput.postAPIHook({\n                action: \"SIGN_OUT\",\n                requestInit: preAPIResult.requestInit,\n                url: preAPIResult.url,\n                fetchResponse: resp.clone(),\n                userContext: input.userContext\n              })];\n\n            case 4:\n              _a.sent();\n\n              return [4\n              /*yield*/\n              , resp.clone().json()];\n\n            case 5:\n              responseJson = _a.sent();\n\n              if (responseJson.status === \"GENERAL_ERROR\") {\n                (0, logger_1.logDebugMessage)(\"doRequest: Throwing general error\");\n                message = responseJson.message === undefined ? \"No Error Message Provided\" : responseJson.message;\n                throw new error_1.STGeneralError(message);\n              }\n\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    },\n    getInvalidClaimsFromResponse: function (input) {\n      return __awaiter(this, void 0, void 0, function () {\n        var body;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (!(\"body\" in input.response)) return [3\n              /*break*/\n              , 2];\n              return [4\n              /*yield*/\n              , input.response.clone().json()];\n\n            case 1:\n              body = _a.sent();\n              return [3\n              /*break*/\n              , 3];\n\n            case 2:\n              if (typeof input.response.data === \"string\") {\n                body = JSON.parse(input.response.data);\n              } else {\n                body = input.response.data;\n              }\n\n              _a.label = 3;\n\n            case 3:\n              return [2\n              /*return*/\n              , body.claimValidationErrors];\n          }\n        });\n      });\n    },\n    getGlobalClaimValidators: function (input) {\n      return input.claimValidatorsAddedByOtherRecipes;\n    },\n    validateClaims: function (input) {\n      return __awaiter(this, void 0, void 0, function () {\n        var accessTokenPayload, _i, _a, validator, err_1, errors, _b, _c, validator, validationRes;\n\n        return __generator(this, function (_d) {\n          switch (_d.label) {\n            case 0:\n              return [4\n              /*yield*/\n              , this.getAccessTokenPayloadSecurely({\n                userContext: input.userContext\n              })];\n\n            case 1:\n              accessTokenPayload = _d.sent();\n              _i = 0, _a = input.claimValidators;\n              _d.label = 2;\n\n            case 2:\n              if (!(_i < _a.length)) return [3\n              /*break*/\n              , 10];\n              validator = _a[_i];\n              return [4\n              /*yield*/\n              , validator.shouldRefresh(accessTokenPayload, input.userContext)];\n\n            case 3:\n              if (!_d.sent()) return [3\n              /*break*/\n              , 9];\n              _d.label = 4;\n\n            case 4:\n              _d.trys.push([4, 6,, 7]);\n\n              return [4\n              /*yield*/\n              , validator.refresh(input.userContext)];\n\n            case 5:\n              _d.sent();\n\n              return [3\n              /*break*/\n              , 7];\n\n            case 6:\n              err_1 = _d.sent();\n              console.error(\"Encountered an error while refreshing validator \".concat(validator.id), err_1);\n              return [3\n              /*break*/\n              , 7];\n\n            case 7:\n              return [4\n              /*yield*/\n              , this.getAccessTokenPayloadSecurely({\n                userContext: input.userContext\n              })];\n\n            case 8:\n              accessTokenPayload = _d.sent();\n              _d.label = 9;\n\n            case 9:\n              _i++;\n              return [3\n              /*break*/\n              , 2];\n\n            case 10:\n              errors = [];\n              _b = 0, _c = input.claimValidators;\n              _d.label = 11;\n\n            case 11:\n              if (!(_b < _c.length)) return [3\n              /*break*/\n              , 14];\n              validator = _c[_b];\n              return [4\n              /*yield*/\n              , validator.validate(accessTokenPayload, input.userContext)];\n\n            case 12:\n              validationRes = _d.sent();\n\n              if (!validationRes.isValid) {\n                errors.push({\n                  validatorId: validator.id,\n                  reason: validationRes.reason\n                });\n              }\n\n              _d.label = 13;\n\n            case 13:\n              _b++;\n              return [3\n              /*break*/\n              , 11];\n\n            case 14:\n              return [2\n              /*return*/\n              , errors];\n          }\n        });\n      });\n    }\n  };\n}\n\nexports.default = RecipeImplementation;","map":{"version":3,"sources":["/home/dom/FlyM/node_modules/supertokens-website/lib/build/recipeImplementation.js"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","__generator","body","_","label","sent","trys","ops","f","y","g","verb","throw","return","Symbol","iterator","v","op","TypeError","pop","push","defineProperty","exports","fetch_1","require","axios_1","version_1","logger_1","error_1","xmlhttprequest_1","RecipeImplementation","recipeImplInput","addXMLHttpRequestInterceptor","logDebugMessage","addInterceptorsToXMLHttpRequest","addFetchInterceptorsAndReturnModifiedFetch","input","url","config","_a","default","doRequest","originalFetch","clone","addAxiosInterceptors","XMLHttpRequest","__interceptedBySuperTokens","console","warn","requestInterceptors","axiosInstance","interceptors","request","handlers","interceptorFunctionRequestFulfilled","use","error","response","responseInterceptor","responseErrorInterceptor","getUserId","tokenInfo","FrontToken","getTokenInfo","undefined","Error","uid","getAccessTokenPayloadSecurely","retry","ate","Date","now","attemptRefreshingSession","userContext","JSON","stringify","up","doesSessionExist","preRequestLSS","refresh","getLocalSessionState","onUnauthorisedResponse","signOut","preAPIResult","resp","responseJson","message","onHandleEvent","action","preAPIHook","requestInit","method","headers","supported_fdi","join","rid","signOutUrl","fetch","status","sessionExpiredStatusCode","postAPIHook","fetchResponse","json","STGeneralError","getInvalidClaimsFromResponse","data","parse","claimValidationErrors","getGlobalClaimValidators","claimValidatorsAddedByOtherRecipes","validateClaims","accessTokenPayload","_i","validator","err_1","errors","_b","_c","validationRes","_d","claimValidators","shouldRefresh","concat","id","validate","isValid","validatorId","reason"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __assign =\n    (this && this.__assign) ||\n    function () {\n        __assign =\n            Object.assign ||\n            function (t) {\n                for (var s, i = 1, n = arguments.length; i < n; i++) {\n                    s = arguments[i];\n                    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n                }\n                return t;\n            };\n        return __assign.apply(this, arguments);\n    };\nvar __awaiter =\n    (this && this.__awaiter) ||\n    function (thisArg, _arguments, P, generator) {\n        function adopt(value) {\n            return value instanceof P\n                ? value\n                : new P(function (resolve) {\n                      resolve(value);\n                  });\n        }\n        return new (P || (P = Promise))(function (resolve, reject) {\n            function fulfilled(value) {\n                try {\n                    step(generator.next(value));\n                } catch (e) {\n                    reject(e);\n                }\n            }\n            function rejected(value) {\n                try {\n                    step(generator[\"throw\"](value));\n                } catch (e) {\n                    reject(e);\n                }\n            }\n            function step(result) {\n                result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n            }\n            step((generator = generator.apply(thisArg, _arguments || [])).next());\n        });\n    };\nvar __generator =\n    (this && this.__generator) ||\n    function (thisArg, body) {\n        var _ = {\n                label: 0,\n                sent: function () {\n                    if (t[0] & 1) throw t[1];\n                    return t[1];\n                },\n                trys: [],\n                ops: []\n            },\n            f,\n            y,\n            t,\n            g;\n        return (\n            (g = { next: verb(0), throw: verb(1), return: verb(2) }),\n            typeof Symbol === \"function\" &&\n                (g[Symbol.iterator] = function () {\n                    return this;\n                }),\n            g\n        );\n        function verb(n) {\n            return function (v) {\n                return step([n, v]);\n            };\n        }\n        function step(op) {\n            if (f) throw new TypeError(\"Generator is already executing.\");\n            while (_)\n                try {\n                    if (\n                        ((f = 1),\n                        y &&\n                            (t =\n                                op[0] & 2\n                                    ? y[\"return\"]\n                                    : op[0]\n                                    ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0)\n                                    : y.next) &&\n                            !(t = t.call(y, op[1])).done)\n                    )\n                        return t;\n                    if (((y = 0), t)) op = [op[0] & 2, t.value];\n                    switch (op[0]) {\n                        case 0:\n                        case 1:\n                            t = op;\n                            break;\n                        case 4:\n                            _.label++;\n                            return { value: op[1], done: false };\n                        case 5:\n                            _.label++;\n                            y = op[1];\n                            op = [0];\n                            continue;\n                        case 7:\n                            op = _.ops.pop();\n                            _.trys.pop();\n                            continue;\n                        default:\n                            if (\n                                !((t = _.trys), (t = t.length > 0 && t[t.length - 1])) &&\n                                (op[0] === 6 || op[0] === 2)\n                            ) {\n                                _ = 0;\n                                continue;\n                            }\n                            if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) {\n                                _.label = op[1];\n                                break;\n                            }\n                            if (op[0] === 6 && _.label < t[1]) {\n                                _.label = t[1];\n                                t = op;\n                                break;\n                            }\n                            if (t && _.label < t[2]) {\n                                _.label = t[2];\n                                _.ops.push(op);\n                                break;\n                            }\n                            if (t[2]) _.ops.pop();\n                            _.trys.pop();\n                            continue;\n                    }\n                    op = body.call(thisArg, _);\n                } catch (e) {\n                    op = [6, e];\n                    y = 0;\n                } finally {\n                    f = t = 0;\n                }\n            if (op[0] & 5) throw op[1];\n            return { value: op[0] ? op[1] : void 0, done: true };\n        }\n    };\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar fetch_1 = require(\"./fetch\");\nvar axios_1 = require(\"./axios\");\nvar version_1 = require(\"./version\");\nvar logger_1 = require(\"./logger\");\nvar error_1 = require(\"./error\");\nvar xmlhttprequest_1 = require(\"./xmlhttprequest\");\nfunction RecipeImplementation(recipeImplInput) {\n    return {\n        addXMLHttpRequestInterceptor: function (_) {\n            (0, logger_1.logDebugMessage)(\"addXMLHttpRequestInterceptorAndReturnModified: called\");\n            (0, xmlhttprequest_1.addInterceptorsToXMLHttpRequest)();\n        },\n        addFetchInterceptorsAndReturnModifiedFetch: function (input) {\n            (0, logger_1.logDebugMessage)(\"addFetchInterceptorsAndReturnModifiedFetch: called\");\n            return function (url, config) {\n                return __awaiter(this, void 0, void 0, function () {\n                    return __generator(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                return [\n                                    4 /*yield*/,\n                                    fetch_1.default.doRequest(\n                                        function (config) {\n                                            return input.originalFetch(\n                                                typeof url === \"string\" ? url : url.clone(),\n                                                __assign({}, config)\n                                            );\n                                        },\n                                        config,\n                                        url\n                                    )\n                                ];\n                            case 1:\n                                return [2 /*return*/, _a.sent()];\n                        }\n                    });\n                });\n            };\n        },\n        addAxiosInterceptors: function (input) {\n            (0, logger_1.logDebugMessage)(\"addAxiosInterceptors: called\");\n            if (XMLHttpRequest.__interceptedBySuperTokens) {\n                console.warn(\n                    \"Not adding axios interceptor since XMLHttpRequest is already added. This is just a warning.\"\n                );\n                console.warn(\"Our axios and XMLHttpRequest interceptors cannot be used at the same time.\");\n                console.warn(\n                    \"Since XMLHttpRequest is added automatically and supports axios by default, you can just remove addAxiosInterceptors from your code.\"\n                );\n                console.warn(\n                    \"If you want to continue using our axios interceptor, you can override addXMLHttpRequestInterceptor with an empty function.\"\n                );\n                (0, logger_1.logDebugMessage)(\n                    \"addAxiosInterceptors: not adding, because XHR interceptors are already in place\"\n                );\n                return;\n            }\n            // we first check if this axiosInstance already has our interceptors.\n            var requestInterceptors = input.axiosInstance.interceptors.request;\n            for (var i = 0; i < requestInterceptors.handlers.length; i++) {\n                if (requestInterceptors.handlers[i].fulfilled === axios_1.interceptorFunctionRequestFulfilled) {\n                    (0, logger_1.logDebugMessage)(\n                        \"addAxiosInterceptors: not adding because already added on this instance\"\n                    );\n                    return;\n                }\n            }\n            // Add a request interceptor\n            input.axiosInstance.interceptors.request.use(axios_1.interceptorFunctionRequestFulfilled, function (error) {\n                return __awaiter(this, void 0, void 0, function () {\n                    return __generator(this, function (_a) {\n                        throw error;\n                    });\n                });\n            });\n            // Add a response interceptor\n            input.axiosInstance.interceptors.response.use(\n                (0, axios_1.responseInterceptor)(input.axiosInstance),\n                (0, axios_1.responseErrorInterceptor)(input.axiosInstance)\n            );\n        },\n        getUserId: function (_) {\n            return __awaiter(this, void 0, void 0, function () {\n                var tokenInfo;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            (0, logger_1.logDebugMessage)(\"getUserId: called\");\n                            return [4 /*yield*/, fetch_1.FrontToken.getTokenInfo()];\n                        case 1:\n                            tokenInfo = _a.sent();\n                            if (tokenInfo === undefined) {\n                                throw new Error(\"No session exists\");\n                            }\n                            (0, logger_1.logDebugMessage)(\"getUserId: returning: \" + tokenInfo.uid);\n                            return [2 /*return*/, tokenInfo.uid];\n                    }\n                });\n            });\n        },\n        getAccessTokenPayloadSecurely: function (input) {\n            return __awaiter(this, void 0, void 0, function () {\n                var tokenInfo, retry;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            (0, logger_1.logDebugMessage)(\"getAccessTokenPayloadSecurely: called\");\n                            return [4 /*yield*/, fetch_1.FrontToken.getTokenInfo()];\n                        case 1:\n                            tokenInfo = _a.sent();\n                            if (tokenInfo === undefined) {\n                                throw new Error(\"No session exists\");\n                            }\n                            if (!(tokenInfo.ate < Date.now())) return [3 /*break*/, 5];\n                            (0,\n                            logger_1.logDebugMessage)(\"getAccessTokenPayloadSecurely: access token expired. Refreshing session\");\n                            return [4 /*yield*/, fetch_1.default.attemptRefreshingSession()];\n                        case 2:\n                            retry = _a.sent();\n                            if (!retry) return [3 /*break*/, 4];\n                            return [\n                                4 /*yield*/,\n                                this.getAccessTokenPayloadSecurely({\n                                    userContext: input.userContext\n                                })\n                            ];\n                        case 3:\n                            return [2 /*return*/, _a.sent()];\n                        case 4:\n                            throw new Error(\"Could not refresh session\");\n                        case 5:\n                            (0,\n                            logger_1.logDebugMessage)(\"getAccessTokenPayloadSecurely: returning: \" + JSON.stringify(tokenInfo.up));\n                            return [2 /*return*/, tokenInfo.up];\n                    }\n                });\n            });\n        },\n        doesSessionExist: function (_) {\n            return __awaiter(this, void 0, void 0, function () {\n                var tokenInfo, preRequestLSS, refresh;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            (0, logger_1.logDebugMessage)(\"doesSessionExist: called\");\n                            return [4 /*yield*/, fetch_1.FrontToken.getTokenInfo()];\n                        case 1:\n                            tokenInfo = _a.sent();\n                            // The above includes getLocalSessionState(true), which would call refresh if the FE cookies were cleared for some reason\n                            if (tokenInfo === undefined) {\n                                (0, logger_1.logDebugMessage)(\"doesSessionExist: access token does not exist locally\");\n                                return [2 /*return*/, false];\n                            }\n                            if (!(tokenInfo.ate < Date.now())) return [3 /*break*/, 4];\n                            (0, logger_1.logDebugMessage)(\"doesSessionExist: access token expired. Refreshing session\");\n                            return [4 /*yield*/, (0, fetch_1.getLocalSessionState)(false)];\n                        case 2:\n                            preRequestLSS = _a.sent();\n                            return [4 /*yield*/, (0, fetch_1.onUnauthorisedResponse)(preRequestLSS)];\n                        case 3:\n                            refresh = _a.sent();\n                            return [2 /*return*/, refresh.result === \"RETRY\"];\n                        case 4:\n                            return [2 /*return*/, true];\n                    }\n                });\n            });\n        },\n        signOut: function (input) {\n            return __awaiter(this, void 0, void 0, function () {\n                var preAPIResult, resp, responseJson, message;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            (0, logger_1.logDebugMessage)(\"signOut: called\");\n                            return [4 /*yield*/, this.doesSessionExist(input)];\n                        case 1:\n                            if (!_a.sent()) {\n                                (0, logger_1.logDebugMessage)(\"signOut: exiting early because session does not exist\");\n                                (0, logger_1.logDebugMessage)(\"signOut: firing SIGN_OUT event\");\n                                recipeImplInput.onHandleEvent({\n                                    action: \"SIGN_OUT\",\n                                    userContext: input.userContext\n                                });\n                                return [2 /*return*/];\n                            }\n                            (0, logger_1.logDebugMessage)(\"signOut: Calling refresh pre API hook\");\n                            return [\n                                4 /*yield*/,\n                                recipeImplInput.preAPIHook({\n                                    action: \"SIGN_OUT\",\n                                    requestInit: {\n                                        method: \"post\",\n                                        headers: {\n                                            \"fdi-version\": version_1.supported_fdi.join(\",\"),\n                                            rid: fetch_1.default.rid\n                                        }\n                                    },\n                                    url: fetch_1.default.signOutUrl,\n                                    userContext: input.userContext\n                                })\n                            ];\n                        case 2:\n                            preAPIResult = _a.sent();\n                            (0, logger_1.logDebugMessage)(\"signOut: Calling API\");\n                            return [4 /*yield*/, fetch(preAPIResult.url, preAPIResult.requestInit)];\n                        case 3:\n                            resp = _a.sent();\n                            (0, logger_1.logDebugMessage)(\"signOut: API ended\");\n                            (0, logger_1.logDebugMessage)(\"signOut: API responded with status code: \" + resp.status);\n                            if (resp.status === recipeImplInput.sessionExpiredStatusCode) {\n                                // refresh must have already sent session expiry event\n                                return [2 /*return*/];\n                            }\n                            if (resp.status >= 300) {\n                                throw resp;\n                            }\n                            return [\n                                4 /*yield*/,\n                                recipeImplInput.postAPIHook({\n                                    action: \"SIGN_OUT\",\n                                    requestInit: preAPIResult.requestInit,\n                                    url: preAPIResult.url,\n                                    fetchResponse: resp.clone(),\n                                    userContext: input.userContext\n                                })\n                            ];\n                        case 4:\n                            _a.sent();\n                            return [4 /*yield*/, resp.clone().json()];\n                        case 5:\n                            responseJson = _a.sent();\n                            if (responseJson.status === \"GENERAL_ERROR\") {\n                                (0, logger_1.logDebugMessage)(\"doRequest: Throwing general error\");\n                                message =\n                                    responseJson.message === undefined\n                                        ? \"No Error Message Provided\"\n                                        : responseJson.message;\n                                throw new error_1.STGeneralError(message);\n                            }\n                            return [2 /*return*/];\n                    }\n                });\n            });\n        },\n        getInvalidClaimsFromResponse: function (input) {\n            return __awaiter(this, void 0, void 0, function () {\n                var body;\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            if (!(\"body\" in input.response)) return [3 /*break*/, 2];\n                            return [4 /*yield*/, input.response.clone().json()];\n                        case 1:\n                            body = _a.sent();\n                            return [3 /*break*/, 3];\n                        case 2:\n                            if (typeof input.response.data === \"string\") {\n                                body = JSON.parse(input.response.data);\n                            } else {\n                                body = input.response.data;\n                            }\n                            _a.label = 3;\n                        case 3:\n                            return [2 /*return*/, body.claimValidationErrors];\n                    }\n                });\n            });\n        },\n        getGlobalClaimValidators: function (input) {\n            return input.claimValidatorsAddedByOtherRecipes;\n        },\n        validateClaims: function (input) {\n            return __awaiter(this, void 0, void 0, function () {\n                var accessTokenPayload, _i, _a, validator, err_1, errors, _b, _c, validator, validationRes;\n                return __generator(this, function (_d) {\n                    switch (_d.label) {\n                        case 0:\n                            return [\n                                4 /*yield*/,\n                                this.getAccessTokenPayloadSecurely({ userContext: input.userContext })\n                            ];\n                        case 1:\n                            accessTokenPayload = _d.sent();\n                            (_i = 0), (_a = input.claimValidators);\n                            _d.label = 2;\n                        case 2:\n                            if (!(_i < _a.length)) return [3 /*break*/, 10];\n                            validator = _a[_i];\n                            return [4 /*yield*/, validator.shouldRefresh(accessTokenPayload, input.userContext)];\n                        case 3:\n                            if (!_d.sent()) return [3 /*break*/, 9];\n                            _d.label = 4;\n                        case 4:\n                            _d.trys.push([4, 6, , 7]);\n                            return [4 /*yield*/, validator.refresh(input.userContext)];\n                        case 5:\n                            _d.sent();\n                            return [3 /*break*/, 7];\n                        case 6:\n                            err_1 = _d.sent();\n                            console.error(\n                                \"Encountered an error while refreshing validator \".concat(validator.id),\n                                err_1\n                            );\n                            return [3 /*break*/, 7];\n                        case 7:\n                            return [\n                                4 /*yield*/,\n                                this.getAccessTokenPayloadSecurely({ userContext: input.userContext })\n                            ];\n                        case 8:\n                            accessTokenPayload = _d.sent();\n                            _d.label = 9;\n                        case 9:\n                            _i++;\n                            return [3 /*break*/, 2];\n                        case 10:\n                            errors = [];\n                            (_b = 0), (_c = input.claimValidators);\n                            _d.label = 11;\n                        case 11:\n                            if (!(_b < _c.length)) return [3 /*break*/, 14];\n                            validator = _c[_b];\n                            return [4 /*yield*/, validator.validate(accessTokenPayload, input.userContext)];\n                        case 12:\n                            validationRes = _d.sent();\n                            if (!validationRes.isValid) {\n                                errors.push({\n                                    validatorId: validator.id,\n                                    reason: validationRes.reason\n                                });\n                            }\n                            _d.label = 13;\n                        case 13:\n                            _b++;\n                            return [3 /*break*/, 11];\n                        case 14:\n                            return [2 /*return*/, errors];\n                    }\n                });\n            });\n        }\n    };\n}\nexports.default = RecipeImplementation;\n"]},"metadata":{},"sourceType":"script"}